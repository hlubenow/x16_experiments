#include <stdio.h>
#include <cx16.h>
#include <conio.h>

/* Not needed: #include <peekpoke.h> */

/* Script-code for compiling and running on Linux:

#!/bin/bash
export CC65_HOME="/usr/share/cc65"
cl65 -O -t cx16 x16_sprite.c -o X16_SPRITE.PRG
---
#!/bin/bash
program="X16_SPRITE.PRG"
x16emu -rom ~/.x16emu/rom.bin -keymap de -prg $program
*/

/*
    x16_sprite.c 1.0 - Translation of the BASIC sprite example by Slithy Matt:

    https://github.com/SlithyMatt/x16-sprite/blob/master/sprite.bas

    Also check out his other sprite demo in C:

    https://github.com/SlithyMatt/x16-demo/blob/master/cc65-sprite/demo.c

    This code here: x16_sprite.c - Copyright (C) 2023 Hauke Lubenow

    This program is free software: you can redistribute it and/or modify
     it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the 
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
*/

#define K_Left  157
#define K_Right 29
#define K_Up    145
#define K_Down  17
#define K_1     49 
#define K_2     50 
#define K_q     81 

typedef unsigned char byte;

void next_frame();

/*-------------------*/
/* Global variables: */

/* sprint frame offsets */
byte fh[] = {0x00, 0x04, 0x08, 0x04};
byte fv[] = {0x00, 0x0c, 0x10, 0x0c};
byte hz = 1;
/* current frame: */
byte cf = 0; 
byte x = 128;
byte y = 128;

byte spritedata[5][128] = {
{0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00, 
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x77,0x77,0x77,0x77,0x77,0x77,0x00,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x00,0x77,0x77,0x77,0x77,0x77,0x77,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00},

{0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00,
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x77,0x77,0x77,0x77,0x77,0x77,0x00,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x07,0x77,0x77,0x77,0x77,0x77,0x00,0x00,
0x77,0x77,0x77,0x77,0x77,0x00,0x00,0x00,
0x77,0x77,0x77,0x77,0x00,0x00,0x00,0x00,
0x77,0x77,0x77,0x77,0x00,0x00,0x00,0x00,
0x77,0x77,0x77,0x77,0x77,0x00,0x00,0x00,
0x07,0x77,0x77,0x77,0x77,0x77,0x00,0x00,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x00,0x77,0x77,0x77,0x77,0x77,0x77,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00},

{0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00,
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x77,0x77,0x77,0x77,0x77,0x00,0x00,
0x07,0x77,0x77,0x77,0x77,0x70,0x00,0x00,
0x07,0x77,0x77,0x77,0x77,0x00,0x00,0x00,
0x77,0x77,0x77,0x77,0x70,0x00,0x00,0x00,
0x77,0x77,0x77,0x77,0x00,0x00,0x00,0x00,
0x77,0x77,0x77,0x77,0x00,0x00,0x00,0x00,
0x77,0x77,0x77,0x77,0x70,0x00,0x00,0x00,
0x07,0x77,0x77,0x77,0x77,0x00,0x00,0x00,
0x07,0x77,0x77,0x77,0x77,0x70,0x00,0x00,
0x00,0x77,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00},

{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x70,0x00,0x00,0x07,0x00,0x00,
0x00,0x07,0x70,0x00,0x00,0x07,0x70,0x00,
0x00,0x77,0x70,0x00,0x00,0x07,0x77,0x00,
0x07,0x77,0x77,0x00,0x00,0x77,0x77,0x70,
0x07,0x77,0x77,0x00,0x00,0x77,0x77,0x70,
0x77,0x77,0x77,0x70,0x07,0x77,0x77,0x77,
0x77,0x77,0x77,0x70,0x07,0x77,0x77,0x77,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x00,0x77,0x77,0x77,0x77,0x77,0x77,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00},

{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x70,0x00,0x00,0x00,0x00,0x07,0x00,
0x07,0x77,0x00,0x00,0x00,0x00,0x77,0x70,
0x07,0x77,0x70,0x00,0x00,0x07,0x77,0x70,
0x77,0x77,0x77,0x00,0x00,0x77,0x77,0x77,
0x77,0x77,0x77,0x70,0x07,0x77,0x77,0x77,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x77,0x77,0x77,0x77,0x77,0x77,0x77,0x77,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x07,0x77,0x77,0x77,0x77,0x77,0x77,0x70,
0x00,0x77,0x77,0x77,0x77,0x77,0x77,0x00,
0x00,0x07,0x77,0x77,0x77,0x77,0x70,0x00,
0x00,0x00,0x77,0x77,0x77,0x77,0x00,0x00,
0x00,0x00,0x00,0x77,0x77,0x00,0x00,0x00} };
/*-------------------*/

void setupSprite() {
    byte i;
    byte u;
    long int adresses[5] = {0x0e000, 0x0e080, 0x0e100, 0x0e180, 0x0e200};

    for (i=0;i<5;i++) {
        for (u=0;u<128;u++) {
            vpoke(spritedata[i][u], adresses[i]+u);
        }
    }

    /* set sprite data; */
    vpoke(0x00, 0x1fc10);
    vpoke(0x07, 0x1fc11);

    /* xpos 128: */
    vpoke(0x80, 0x1fc12);
    vpoke(0x00, 0x1fc13);

    /* ypos 128: */ 
    vpoke(0x80, 0x1fc14);
    vpoke(0x00, 0x1fc15);

    /* no collision, zdepth 3, no flip: */
    vpoke(0x0c, 0x1fc16);

    /* 16x16 pixels, palette offset 0: */
    vpoke(0x50, 0x1fc17); /* 16x16 pixels, palette offset 0 */
}

void enableSprites() {
    /* Not needed: POKE(0x9f29,(0x40 | PEEK(0x9f29))); */
    vera_sprites_enable(1);
}

void move_left() {
    x--;
    vpoke(x & 0xff, 0x1fc12);
    vpoke((x & 0x0300) / 0x100, 0x1fc13);
    hz = 1;
    next_frame();
    vpoke(0x0d, 0x1fc16); /* h-flip */
}

void move_right() {
    x++;
    vpoke(x & 0xff, 0x1fc12);
    vpoke((x & 0x0300) / 0x100, 0x1fc13);
    hz = 1;
    next_frame();
    vpoke(0x0c, 0x1fc16); /* no flip */
}

void move_up() {
    y--;
    vpoke(y & 0xff, 0x1fc14);
    vpoke((y & 0x0300) / 0x100, 0x1fc15);
    hz = 0;
    next_frame();
    vpoke(0x0c, 0x1fc16); /* no flip */
}

void move_down() {
    y++;
    vpoke(y & 0xff, 0x1fc14);
    vpoke((y & 0x0300) / 0x100, 0x1fc15);
    hz = 0;
    next_frame();
    vpoke(0x0e, 0x1fc16); /* v-flip */
}

void next_frame() {
    int fr;
    int cp;
    cf++;
    if (cf > 11) {
        cf = 0;
    }
    if (hz == 1) {
        fr = fh[cf/3];
    } else {
        fr = fv[cf/3];
    }
    vpoke(fr, 0x1fc10);
    cp = (((x+8) / 8 & 0x7f) + ((y+8) * 16 & 0x7f80)) * 2;
    if (cp > 0x3ffe) {
        cp = 0x3ffe;
    }
    vpoke(0x20, cp + 0xb000 + 0x10000);
}


int main() {
    byte key = 0;
    byte choicekey = 0;
    byte firstselection = 1;
    int horizontal = 300;
    int vertical   = 200;
    byte checkkey = 0;
    int i;
    setupSprite();
    /* Switch back to the uppercase character set: */
    cbm_k_bsout(CH_FONT_UPPER);
    puts("\nsprite demo\n");
    puts("\npress '1' or '2' to choose, or 'q' to quit:");
    puts("\n1. move the sprite with cursor keys.\n");
    puts("2. move around quickly (just to show the speed).\n");

    /* Main Loop: */
    while(1) {
        choicekey = 0;
        checkkey = 0;
        while (choicekey != K_1 && choicekey != K_2) {
            choicekey = cbm_k_getin();
            if (choicekey == K_q) {
                return 0;
            }
        }
        if (firstselection == 1) {
            enableSprites();
            firstselection = 0;
        }
        if (choicekey == K_1) {
            while(key != K_q) {
                key = cbm_k_getin();
                if (key == K_Left && x > 0) {
                    move_left();
                }
                if (key == K_Right && x < 640) {
                    move_right();
                }
                if (key == K_Up && y > 0) {
                    move_up();
                }
                if (key == K_Down && y < 480) {
                    move_down();
                }
            }
        }
        if (choicekey == K_2) {
            while(checkkey != K_q) {
                for (i=0; i<horizontal; i++) {
                    move_right();
                    key = cbm_k_getin();
                    if (key == K_q) {
                        checkkey = K_q;
                    }
                }
                if (checkkey == K_q) {
                    break;
                }
                for (i=0; i<vertical; i++) {
                    move_down();
                    key = cbm_k_getin();
                    if (key == K_q) {
                        checkkey = K_q;
                    }
                }
                if (checkkey == K_q) {
                    break;
                }
                for (i=0; i<horizontal; i++) {
                    move_left();
                    key = cbm_k_getin();
                    if (key == K_q) {
                        checkkey = K_q;
                    }
                }
                if (checkkey == K_q) {
                    break;
                }
                for (i=0; i<vertical; i++) {
                    move_up();
                    key = cbm_k_getin();
                    if (key == K_q) {
                        checkkey = K_q;
                    }
                }
                if (checkkey == K_q) {
                    break;
                }
            }
        }
    }
    return 0;
}
